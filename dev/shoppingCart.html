<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>shopping_cart_page</title>

    <!-- css -->
    @@loop('template/csslink.html',[
    {"csslink" : "//cdn.jsdelivr.net/npm/alertifyjs@1.11.4/build/css/alertify.min.css"},
    {"csslink" : "//cdn.jsdelivr.net/npm/alertifyjs@1.11.4/build/css/themes/default.min.css"},
    {"csslink" : "css/style.css"},
    {"csslink" : "css/owl.carousel.min.css"},
    {"csslink" : "css/owl.theme.default.css"}
    ])

</head>

<body class="shoppingCart_page">

    <header class="header_navbar">
        @@include("template/header.html")
    </header>
    <div class="section_title">購物車</div>
    <section class="container ">
        <div id="cartUpdateFormWrap" class="m_jg_0_50 m0_35">
            <div class="shopping_cart_title dis_n">
                <div class="col-lg-3 dis_f_jc_c shopping_cart_title_text">
                    <h5 class="m-0">商品圖片</h5>
                </div>
                <div class="col-lg-3 dis_f_jc_c shopping_cart_title_text">
                    <h5 class="m-0">商品名稱</h5>
                </div>
                <div class="col-lg-2 dis_f_jc_c shopping_cart_title_text">
                    <h5 class="m-0">單價</h5>
                </div>
                <div class="col-lg-2 dis_f_jc_c shopping_cart_title_text">
                    <h5 class="m-0">數量</h5>
                </div>
                <div class="col-lg-2 dis_f_jc_c shopping_cart_title_text">
                    <h5 class="m-0">小計</h5>
                </div>
                <div class="col-lg-2 dis_f_jc_c shopping_cart_title_text col-lg-1">
                    <h5 class="m-0">刪除</h5>
                </div>
            </div>
            <form class="bt" style="display: none">
                <div class="bg_fdfff3">
                    <div class="shopping_cart  m40_0_0  dis_f_jc_c">
                        <div class="col48 m-a col-lg-3 dis_f_jc_c shopping_cart_item bl">
                            <div class="po-r w-50p m-a">
                                <img class="shoppingCartContentImg" src="">
                                <input type="hidden" name="pImage" value="towel4.png">
                            </div>
                        </div>
                        <div class="col48 col-lg-3 dis_f_jc_c shopping_cart_item bl">
                            <p class="shoppingCartContentPdName"></p>
                            <input type="hidden" name="pName" value="仙人掌-紅色">
                            <p class="dis-lg-n">單價：$<span class="thePrice dis-lg-n"></span></p>
                            <!-- <p class="thePrice dis-lg-n">單價：$450</p> -->
                        </div>
                        <div class="dis_n col-lg-2 dis_f_jc_c shopping_cart_item bl">
                            <p>$<span class="thePrice"></span></p>
                            <input type="hidden" name="pPrice" value="299">
                        </div>
                        <div class="col48 col-lg-2 dis_f_jc_c shopping_cart_item bl">
                            <div class="dis_f_jc_c ai-fs">
                                <button type="button" class="btnLess">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="text" value="1" name="pQuantity" class="quantity" readonly>
                                <button type="button" class="btnPlus">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col48 col-lg-2 dis_f_jc_c shopping_cart_item bl">
                            <p>NT.<span class="thePrice subtotal">0</span></p>
                            <input type="hidden" name="pPrice" value="299">
                        </div>
                        <div class="dis_n col-lg-2 dis_f_jc_c shopping_cart_item bl">
                            <div class="trash_btn">
                                <input type="hidden" name="pNo" value="9">
                                <button type="submit" class="deleteBtn btn--active btn_bor">刪除</button>
                            </div>
                        </div>
                        <div class="trash_icon deleteBtn">
                            <button type="submit" class="trash">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
            <div class="bg_fdfff3 bg_fdfff3_d ta-r p10 bt">
                <p class="ta-r dis-lg-ib mb-0 mt-15 mt-lg-0">總計：<span id="sumTotalPrice"></span>元</p>
            </div>
            <div class="cotainer dis_f_j_c">
                <a class="btn dis_ib mlr" href="items.html">繼續購物</a>
                <button type="submit" class="btn mlr" id="check">進行結帳</button>
            </div>
        </div>
    </section>
    <section class="item_recom_section container_mb">
        <h3 class="section_title">推薦商品</h3>
        <div class="shop-tab-inner">
            <div class="col-2 col-xl-1 ta-r v-xl-hide">
                <img src="images/product/arrow_left.png" alt="" class="prev po-r w-40 pointer">
            </div>
            <!-- <div class="sort_same pt350 owl-carousel owl-theme"> -->
            <div class="sort_same owl-carousel owl-theme">
                <div class="hoverObj card_bg card_bg1 related_item">
                    <div class="gray_linear_gradient center">
                        <div class="sort_same_item_img center">
                            <img src="images/products/product_list/pd_b-37.png">
                        </div>
                        <p class="sort_same_item_title text_align_c">仙人掌包包</p>
                        <p class="sort_same_item_price text_align_c">NT.450</p>
                        <div class="btn m-b m-a addCartButton">加入購物車</div>
                    </div>
                    <input type="hidden" name="">
                </div>
                <div class="hoverObj card_bg card_bg1 related_item">
                    <div class="gray_linear_gradient center">
                        <div class="sort_same_item_img center">
                            <img src="images/products/product_list/pd_b-37.png">
                        </div>
                        <p class="sort_same_item_title text_align_c">仙人掌包包</p>
                        <p class="sort_same_item_price text_align_c">NT.450</p>
                        <div class="btn m-b m-a addCartButton">加入購物車</div>
                    </div>
                    <input type="hidden" name="">
                </div>
                <div class="hoverObj card_bg card_bg1 related_item">
                    <div class="gray_linear_gradient center">
                        <div class="sort_same_item_img center">
                            <img src="images/products/product_list/pd_b-37.png">
                        </div>
                        <p class="sort_same_item_title text_align_c">仙人掌包包</p>
                        <p class="sort_same_item_price text_align_c">NT.450</p>
                        <div class="btn m-b m-a addCartButton">加入購物車</div>
                    </div>
                    <input type="hidden" name="">
                </div>
                <div class="hoverObj card_bg card_bg1 related_item">
                    <div class="gray_linear_gradient center">
                        <div class="sort_same_item_img center">
                            <img src="images/products/product_list/pd_b-37.png">
                        </div>
                        <p class="sort_same_item_title text_align_c">仙人掌包包</p>
                        <p class="sort_same_item_price text_align_c">NT.450</p>
                        <div class="btn m-b m-a addCartButton">加入購物車</div>
                    </div>
                    <input type="hidden" name="">
                </div>
            </div>
            <div class="col-2 col-xl-1 v-xl-hide">
                <img src="images/product/arrow_right.png" alt="" class="next po-r w-40 pointer">
            </div>
        </div>
    </section>
    <div class="please_login" id="pleaseLogin" style="display: none">
        <div class="please_login_wrap">
            <div class="close_popup">
                <i class="far fa-times-circle"></i>
            </div>
            <h3>請先登入</h3>
            <div class="btn_login">
                <button class="btn--active btn_bor showloginBox">登入</button>
            </div>
        </div>
    </div>
    @@include("template/footer.html")

    <!-- js -->
    @@loop('template/jslink.html',[
    {"jslink" : "//cdn.jsdelivr.net/npm/alertifyjs@1.11.4/build/alertify.min.js"},
    {"jslink" : "js/alertifyJSset.js"},
    {"jslink" : "https://kit.fontawesome.com/6a6d2775fc.js"},
    {"jslink" : "js/jquery.min.js"},
    {"jslink" : "js/owl.carousel.js"}
    ])

    <script>
        $('.owl-carousel').each(function () {
            $(this).owlCarousel({
                loop: false,
                margin: 0,
                nav: false,
                responsiveClass: true,
                responsive: {
                    0: {
                        items: 1,
                    },
                    768: {
                        items: 2
                    },
                    1200: {
                        items: 4
                    }
                },
            });
            $(this).siblings().find('.next').click(function () {
                $(this).parent().siblings('.owl-carousel').trigger('next.owl.carousel');
            });
            $(this).siblings().find('.prev').click(function () {
                $(this).parent().siblings('.owl-carousel').trigger('prev.owl.carousel');
            });
        });

    </script>
    <!-- -----------購物車內頁商品動態新增start-------- -->
    <script>
        var storage = sessionStorage;
        if (storage['addItemList'] == null) {
            storage['addItemList'] = '';    //storage.setItem('addItemList','');
        }
        function shopingCartFirst() {
            sumTotalPrice = 0
            let itemString = storage['addItemList'];
            // console.log(itemString);
            if (storage['addItemList']) {
                let items = itemString.substr(0, itemString.length - 2).split(', ');
                // console.log(items);   // ["A1001", "A1005", "A1002"] //
                for (let key in items) {  //use items[key]
                    let itemInfo = storage.getItem(items[key]);// itemInfo="formas|formas.png|$3000"
                    // console.log(itemInfo);
                    createCartContentList(itemInfo, items[key]);//items[key]="A1001"
                }
            }

            function createCartContentList(itemInfo, key) {
                // console.log(key);
                let cartUpdateFormClone = document.getElementById("cartUpdateFormWrap").children[1].cloneNode(true);
                cartUpdateFormClone.id = key;
                // console.log(cartUpdateFormClone);
                cartUpdateFormClone.style.display = '';
                // document.getElementById("cartUpdateFormWrap").appendChild(cartUpdateFormClone);

                document.getElementById("cartUpdateFormWrap").insertBefore(cartUpdateFormClone, document.getElementById("cartUpdateFormWrap").lastElementChild.previousElementSibling);
                //lastElementChild最後一個小孩
                //previousElementSibling我的上一個兄弟


                //console.log(cartUpdateFormClone.children[0].children[0].children[4].children[0].children[0]);//test

                cartUpdateFormClone.children[0].children[0].children[0].children[0].children[0].src = itemInfo.split('|')[1];
                cartUpdateFormClone.children[0].children[0].children[0].children[0].children[0].src = itemInfo.split('|')[1];

                cartUpdateFormClone.children[0].children[0].children[1].children[0].innerText = itemInfo.split('|')[0];
                cartUpdateFormClone.children[0].children[0].children[3].children[0].children[1].value = itemInfo.split('|')[3];
                // console.log(cartUpdateFormClone.children[0].children[0].children[3]);
                cartUpdateFormClone.children[0].children[0].children[2].children[0].children[0].innerText = itemInfo.split('|')[2];
                cartUpdateFormClone.children[0].children[0].children[4].children[0].children[0].innerText = parseInt(itemInfo.split('|')[2]) * parseInt(itemInfo.split('|')[3]);//小計
                // console.log(cartUpdateFormClone.children[0].children[0].children[4].children[0].children[0]);
                cartUpdateFormClone.children[0].children[0].children[1].children[2].children[0].innerText = itemInfo.split('|')[2];//手機版單價
            }


            let delButton = document.getElementsByClassName('deleteBtn');
            // console.log(delButton)

            for (let i = 0; i < delButton.length; i++) {
                delButton[i].style.cursor = "pointer";
                delButton[i].addEventListener('click', deleteItem);
            }
            function deleteItem(e) {
                e.preventDefault()
                // let itemId = this.parentNode.getAttribute('id');
                let key = this.parentNode.parentNode.parentNode.parentNode.parentNode.id;
                alertify.alert(key);
                //1.先扣除總金額
                // sumTotalPrice -= parseInt(itemValue.split('|')[2]);//parseInt:字串轉數字
                // document.getElementById('sumTotalPrice').innerText = sumTotalPrice;
                let sumTotalPrice = document.getElementById('sumTotalPrice').innerText;
                // let itemValue = storage.getItem(key);
                sumTotalPrice -= parseInt(this.parentNode.parentNode.previousElementSibling.children[0].children[0].innerText);
                //this是我的btn,parentNode是的爸爸
                document.getElementById('sumTotalPrice').innerText = sumTotalPrice;

                //2.清除storage的資料
                storage.removeItem(key);
                storage['addItemList'] = storage['addItemList'].replace(key + ', ', '');

                //3.刪除該筆form
                // this.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode);
                this.parentNode.parentNode.parentNode.parentNode.parentNode.remove();
                //console.log(this.parentNode.parentNode.parentNode.parentNode.parentNode);
                First();
            }
        }
        shopingCartFirst();

    </script>
    <!-- -----------購物車動態新增end-------- -->

    <!-- -----------購物車數量及小計end-------- -->
    <script>
        (function () {
            let btnLess = document.querySelectorAll(".btnLess");
            let btnPlus = document.querySelectorAll(".btnPlus");
            let total = 0;
            let eachSubTotal = document.querySelectorAll('.subtotal');
            for (let i = 0; i < eachSubTotal.length; i++) {
                total += parseInt(eachSubTotal[i].innerText);
            }
            let sumTotalPrice = document.getElementById('sumTotalPrice');
            sumTotalPrice.innerText = total;
            for (let i = 0; i < btnLess.length; i++) {
                btnLess[i].style.cursor = "pointer";
                btnPlus[i].style.cursor = "pointer";
                btnLess[i].addEventListener('click', function () {
                    if (this.nextElementSibling.value > 1) {
                        this.nextElementSibling.value -= 1;
                        this.parentNode.parentNode.nextElementSibling.children[0].children[0].innerText = this.nextElementSibling.value * this.parentNode.parentNode.previousElementSibling.children[0].children[0].innerText;
                        sumTotalPrice.innerText = parseInt(sumTotalPrice.innerText) - parseInt(this.parentNode.parentNode.previousElementSibling.children[0].children[0].innerText);
                        let itemInfo = storage[this.parentNode.parentNode.parentNode.parentNode.parentNode.id];
                        itemInfo = itemInfo.split('|')[0] + '|' + itemInfo.split('|')[1] + '|' + itemInfo.split('|')[2] + '|' + this.nextElementSibling.value;
                        storage[this.parentNode.parentNode.parentNode.parentNode.parentNode.id] = itemInfo;
                        // console.log(this.parentNode.parentNode.parentNode.parentNode.parentNode);
                        // console.log(id);
                    }
                }, false);
                btnPlus[i].addEventListener('click', function () {
                    this.previousElementSibling.value = parseInt(this.previousElementSibling.value) + 1;
                    this.parentNode.parentNode.nextElementSibling.children[0].children[0].innerText = this.previousElementSibling.value * this.parentNode.parentNode.previousElementSibling.children[0].children[0].innerText;
                    sumTotalPrice.innerText = parseInt(sumTotalPrice.innerText) + parseInt(this.parentNode.parentNode.previousElementSibling.children[0].children[0].innerText);
                    let itemInfo = storage[this.parentNode.parentNode.parentNode.parentNode.parentNode.id];
                    itemInfo = itemInfo.split('|')[0] + '|' + itemInfo.split('|')[1] + '|' + itemInfo.split('|')[2] + '|' + this.previousElementSibling.value;
                    storage[this.parentNode.parentNode.parentNode.parentNode.parentNode.id] = itemInfo;
                }, false);
            }
        })();</script>
    <!-- -----------購物車數量及小計end-------- -->
    <script>
        document.getElementById('check').addEventListener('click', function () {

            if (storage['member_no']) {//有登入
                if(storage['addItemList'])
                    window.location='check_order.html';
                else
                    alertify.alert('請先選購商品喔');  
            } else {//沒登入
                document.getElementById('pleaseLogin').style.display = "";
                document.querySelector('.showloginBox').addEventListener('click',function(){
                    $('#lightBox').css('display', 'block');
                    document.getElementById('pleaseLogin').style.display = "none";
                    order=1;
                });
            }
        }, false);

    </script>

    <script>
        //撈取相關推薦商品
        function getSameProduct() {
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status == 200) {
                    //modify here
                    let SameProductlist = JSON.parse(xhr.responseText);
                    // let SameArray = [];
                    // SameProductlist.forEach(element => {
                    //     if (element.product_category == document.getElementById("same_product_category").value && window.location.href.split("product_no=")[1] != element.product_no) {
                    //         SameArray.push(element);
                    //     }
                    // });
                    // console.log(SameArray);
                    for (let i = 0; i < 4; i++) {
                        // console.log(Math.floor(Math.random()*SameArray.length));
                        let related_items = document.querySelectorAll('.related_item');
                        let randomNum = Math.floor(Math.random() * SameProductlist.length);
                        // console.log(SameProductlist[randomNum]);
                        related_items[i].children[0].children[0].children[0].src = SameProductlist[randomNum].product_image;
                        related_items[i].children[0].children[1].innerText = SameProductlist[randomNum].product_name;
                        related_items[i].children[0].children[2].innerText = "NT." + SameProductlist[randomNum].product_price;
                        related_items[i].children[1].value = SameProductlist[randomNum].product_no;
                        SameProductlist.splice(randomNum, 1);
                        // console.log(SameArray);
                    }
                    var storage = sessionStorage;
                    let name;
                    let image;
                    let price;
                    function sameitemAddCart() {
                        if (storage['addItemList'] == null) {
                            storage['addItemList'] = '';    //storage.setItem('addItemList','');
                        }

                        let list = document.querySelectorAll('.addCartButton');     //list是陣列

                        for (let i = 0; i < list.length; i++) {
                            list[i].addEventListener('click', function () {
                                // console.log(this.parentNode.nextElementSibling.value);
                                name = this.previousElementSibling.previousElementSibling.innerText;
                                image = this.previousElementSibling.previousElementSibling.previousElementSibling.children[0].src;
                                image = image.substr(image.indexOf('images'));
                                price = this.previousElementSibling.innerText;
                                price = price.replace('NT.', "");
                                productInfo = `${name}|${image}|${price}`;
                                // console.log(productInfo);
                                addItem(this.parentNode.nextElementSibling.value, productInfo);
                                First();

                            });
                        }

                    }
                    function addItem(itemId, itemValue) {
                        alertify.alert(`${itemId} : ${itemValue}`);
                        //存入storage,判斷是否為重複商品，如果重複就不增加
                        itemId = `pd-${itemId}`;
                        if (storage[itemId]) {
                            alertify.alert(`商品 : ${name} ，已經加入購物車了喔`);
                        } else {
                            alertify.alert(`商品 : ${name} ，加入購物車成功`);
                            storage['addItemList'] += itemId + ', ';
                            itemValue = itemValue + "|1";
                            storage[itemId] = itemValue;
                        }
                    }
                    sameitemAddCart();

                } else {
                    alert(xhr.status);
                }
            }
            var url = `php/getProduct_JSON.php`;
            xhr.open("Get", url, true);
            xhr.send(null);
        }
        getSameProduct();
    </script>
</body>

</html>
